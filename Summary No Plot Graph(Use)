import pandas as pd
import os
import tkinter as tk
from tkinter import filedialog
from openpyxl.styles import Font


def get_experiment_info():
    scenarios = [
        "‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥",
        "‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡∏ä‡πâ‡∏≤",
        "‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Ç‡∏ß‡∏≤",
        "‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏ã‡πâ‡∏≤‡∏¢",
        "‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤",
        "‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏∞‡∏á‡∏±‡∏Å"
    ]

    print("\n" + "=" * 40)
    print("   ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á (Scenario)")
    print("=" * 40)
    for index, scenario in enumerate(scenarios, 1):
        print(f" [{index}] {scenario}")
    print("-" * 40)

    while True:
        choice = input("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç (1-6): ").strip()
        if choice.isdigit() and 1 <= int(choice) <= 6:
            selected_scenario = scenarios[int(choice) - 1]
            break
        else:
            print("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç 1-6")

    subject_name = input("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏î‡∏•‡∏≠‡∏á: ").strip()
    return f"{selected_scenario} : {subject_name}"


def process_sensor_file(file_path, header_title):
    print(f"\nüìÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå: {file_path}")

    df = pd.read_csv(file_path)

    target_columns = [
        'ACC_X', 'ACC_Y', 'ACC_Z',
        'GYRO_X', 'GYRO_Y', 'GYRO_Z',
        'MAG_X', 'MAG_Y', 'MAG_Z'
    ]

    valid_columns = [col for col in target_columns if col in df.columns]
    if not valid_columns:
        print("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ")
        return

    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    stats_data = {}
    for col in valid_columns:
        series = pd.to_numeric(df[col], errors='coerce')
        stats_data[col] = {
            'Mean': series.mean(),
            'Median': series.median(),
            'SD': series.std(),
            'Skewness': series.skew(),
            'Kurtosis': series.kurt(),
            'Max': series.max(),
            'Min': series.min()
        }

    summary_df = pd.DataFrame(stats_data)

    # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
    output_filename = os.path.splitext(file_path)[0] + '_summary.xlsx'

    with pd.ExcelWriter(output_filename, engine='openpyxl') as writer:
        df.to_excel(writer, sheet_name='Raw Data', index=False)

        summary_df.to_excel(writer, sheet_name='Summary Stats', startrow=2)

        workbook = writer.book
        worksheet = writer.sheets['Summary Stats']

        worksheet['A1'] = "‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á:"
        worksheet['B1'] = header_title

        bold = Font(bold=True, size=12)
        worksheet['A1'].font = bold
        worksheet['B1'].font = bold

    print(f"‚úî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå: {output_filename}")


if __name__ == "__main__":
    # ‡∏£‡∏±‡∏ö Scenario + ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏•‡∏≠‡∏á
    experiment_title = get_experiment_info()

    # ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå
    root = tk.Tk()
    root.withdraw()
    root.attributes('-topmost', True)

    print("\n‚è≥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢...")

    file_paths = filedialog.askopenfilenames(
        title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå",
        filetypes=[("CSV Files", "*.csv"), ("All Files", "*.*")]
    )

    if file_paths:
        print(f"\nüì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: {len(file_paths)} ‡πÑ‡∏ü‡∏•‡πå")
        for file_path in file_paths:
            process_sensor_file(file_path, experiment_title)
        print("\nüéâ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!")
    else:
        print("‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô")
