import pandas as pd
import tkinter as tk
from tkinter import filedialog
import os

def normalize_inplace_baseline(df, cols):
    """
    ‡πÅ‡∏ö‡∏ö In-place Baseline:
    - ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å: ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô 0
    - ‡πÅ‡∏ñ‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: new = current_raw - previous_new
    - ‡πÉ‡∏ä‡πâ previous ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß
    """

    df_norm = df.copy()

    # ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Å‡πà‡∏≠‡∏ô
    df_norm[cols] = df_norm[cols].apply(pd.to_numeric, errors="coerce")

    # ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ö‡∏ö update ‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ
    for col in cols:
        df_norm.loc[0, col] = 0  # ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å

        for i in range(1, len(df_norm)):
            prev = df_norm.loc[i - 1, col]      # previous = ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å baseline ‡πÅ‡∏•‡πâ‡∏ß
            current = df_norm.loc[i, col]       # current = ‡∏Ñ‡πà‡∏≤‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô numeric ‡πÅ‡∏•‡πâ‡∏ß

            # ‡∏Å‡∏£‡∏ì‡∏µ NaN ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ = 0
            if pd.isna(prev):
                prev = 0
            if pd.isna(current):
                current = 0

            df_norm.loc[i, col] = current - prev

    return df_norm


def find_sensor_columns(df):
    pref = ("ACC_", "GYRO_", "MAG_")
    return [c for c in df.columns if c.startswith(pref)]


def main():
    root = tk.Tk()
    root.withdraw()

    file_paths = filedialog.askopenfilenames(
        title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV",
        filetypes=[("CSV Files", "*.csv")]
    )

    if not file_paths:
        print("‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå")
        return

    for file_path in file_paths:
        print(f"\n‚û° ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•: {file_path}")

        df = pd.read_csv(file_path)

        sensor_cols = find_sensor_columns(df)
        if not sensor_cols:
            sensor_cols = df.select_dtypes(include=["number"]).columns.tolist()
            print("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö ACC/GYRO/MAG ‚Üí ‡πÉ‡∏ä‡πâ numeric ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:", sensor_cols)

        df_norm = normalize_inplace_baseline(df, sensor_cols)

        folder = os.path.dirname(file_path)
        base = os.path.basename(file_path)
        name = os.path.splitext(base)[0]
        output = os.path.join(folder, f"{name}_baseline.csv")

        df_norm.to_csv(output, index=False)

        print(f"‚úî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå: {output}")
        print(df_norm[sensor_cols].head())

    print("\nüéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!")


if __name__ == "__main__":
    main()
